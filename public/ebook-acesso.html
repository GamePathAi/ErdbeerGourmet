<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acesso ao Ebook - Morango Gourmet</title>
    <link rel="stylesheet" href="/ebook-access.css">
</head>
<body class="bg-gray-50">
    <div class="max-w-2xl mx-auto p-8">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">
                üçì Acesso ao Ebook
            </h1>
            
            <div id="loading" class="mb-6">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Verificando seu acesso...</p>
            </div>
            
            <div id="access-granted" style="display: none;" class="text-center">
                <div class="text-green-600 text-4xl mb-4">‚úÖ</div>
                <h2 class="text-xl font-bold text-green-800 mb-4">Acesso Autorizado!</h2>
                <p id="customer-info" class="text-gray-600 mb-4">Redirecionando para sua √°rea de acesso...</p>
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto mb-4"></div>
            </div>
            
            <div id="access-denied" style="display: none;" class="text-center">
                <div class="text-red-600 text-4xl mb-4">‚ùå</div>
                <h2 class="text-xl font-bold text-red-800 mb-4">Acesso Negado</h2>
                <p id="error-message" class="text-gray-600 mb-4">Token inv√°lido ou expirado.</p>
                <a href="/" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                    üè† Voltar ao In√≠cio
                </a>
            </div>
        </div>
    </div>

    <script>
      async function verifyAccess() {
         const urlParams = new URLSearchParams(window.location.search);
         const token = urlParams.get('token');
         const sessionId = urlParams.get('session_id');
         
         try {
           // Verificar se √© um token de demonstra√ß√£o
           if (token && token.startsWith('demo_')) {
             document.getElementById('loading').style.display = 'none';
             document.getElementById('access-granted').style.display = 'block';
             
             const customerInfo = document.getElementById('customer-info');
             if (customerInfo) {
               customerInfo.textContent = 'Bem-vindo(a)! Esta √© uma demonstra√ß√£o do sistema.';
             }
             return;
           }
           
           let response;
           
           const baseUrl = (window.location.hostname === 'localhost' && window.location.port !== '4173') ? 'http://localhost:8888' : window.location.origin;
           
           if (sessionId) {
             // Validar compatibilidade entre ambiente e session_id
             const isLiveSession = sessionId.startsWith('cs_live_');
             const isDevEnvironment = window.location.hostname === 'localhost';
             
             if (isLiveSession && isDevEnvironment) {
               // Redirecionar para produ√ß√£o
               console.log('Redirecionando session_id de produ√ß√£o para ambiente correto...');
               window.location.href = `https://erdbeergourmet.ch/ebook-acesso.html?session_id=${sessionId}`;
               return;
             }
             
             // Get access token from session ID
             response = await fetch(`${baseUrl}/.netlify/functions/get-ebook-access?session_id=${sessionId}`);
             const data = await response.json();
             
             if (response.ok && data.accessToken) {
               // Redirect with access token
               window.location.href = `/ebook-acesso?token=${data.accessToken}`;
               return;
             } else {
               throw new Error(data.error || 'Acesso n√£o encontrado');
             }
           } else if (token) {
             // Verify access token
             response = await fetch(`${baseUrl}/.netlify/functions/verify-ebook-access?token=${token}`);
             const data = await response.json();
             
             if (response.ok && data.hasAccess) {
               document.getElementById('loading').style.display = 'none';
               document.getElementById('access-granted').style.display = 'block';
               
               // Update customer info if available
               if (data.customer) {
                 const customerInfo = document.getElementById('customer-info');
                 if (customerInfo) {
                   customerInfo.textContent = `Bem-vindo(a), ${data.customer.name}! Redirecionando...`;
                 }
               }
               
               // Redirecionar para p√°gina de acesso confirmado ap√≥s 2 segundos
               setTimeout(() => {
                 window.location.href = `/acesso-confirmado.html?token=${token}`;
               }, 2000);
               
               return;
             }
           }
           
           throw new Error('Token inv√°lido ou expirado');
         } catch (error) {
           console.error('Erro ao verificar acesso:', error);
           document.getElementById('loading').style.display = 'none';
           document.getElementById('access-denied').style.display = 'block';
           
           const errorMsg = document.getElementById('error-message');
           if (errorMsg) {
             errorMsg.textContent = error.message;
           }
         }
       }
      
      // Start verification when page loads
      verifyAccess();
    </script>
</body>
</html>