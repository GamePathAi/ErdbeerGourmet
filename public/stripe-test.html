<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß TESTE CR√çTICO - Valida√ß√£o Stripe CSP</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .critical { background: #dc3545; }
        .critical:hover { background: #c82333; }
        #console-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üö® TESTE CR√çTICO DE PRODU√á√ÉO - Stripe CSP</h1>
        <div class="info">
            <strong>OBJETIVO:</strong> Validar se o Content Security Policy permite funcionamento completo do Stripe
        </div>
    </div>

    <div class="test-container">
        <h2>üìã Checklist de Valida√ß√£o</h2>
        <div id="test-results">
            <div class="warning">‚è≥ Aguardando execu√ß√£o dos testes...</div>
        </div>
        <button onclick="runAllTests()">üîÑ Executar Todos os Testes</button>
        <button onclick="testStripeCheckout()" class="critical">üí≥ Teste Cr√≠tico - Stripe Checkout</button>
    </div>

    <div class="test-container">
        <h2>üñ•Ô∏è Console de Monitoramento</h2>
        <div id="console-output">Iniciando monitoramento...
</div>
        <button onclick="clearConsole()">üóëÔ∏è Limpar Console</button>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        let testResults = [];
        const consoleOutput = document.getElementById('console-output');
        const resultsDiv = document.getElementById('test-results');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            consoleOutput.textContent += logMessage + '\n';
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            console.log(logMessage);
        }

        function updateResults() {
            let html = '';
            testResults.forEach(result => {
                const statusClass = result.success ? 'success' : 'error';
                const icon = result.success ? '‚úÖ' : '‚ùå';
                html += `<div class="${statusClass}">${icon} ${result.name}: ${result.message}</div>`;
            });
            resultsDiv.innerHTML = html;
        }

        function addTestResult(name, success, message) {
            testResults.push({ name, success, message });
            updateResults();
            log(`${name}: ${success ? 'SUCESSO' : 'FALHA'} - ${message}`);
        }

        // Teste 1: Verificar se Stripe SDK carregou
        function testStripeSDK() {
            log('üîç Testando carregamento do Stripe SDK...');
            if (typeof Stripe !== 'undefined') {
                addTestResult('Stripe SDK', true, 'SDK carregado com sucesso');
                return true;
            } else {
                addTestResult('Stripe SDK', false, 'SDK n√£o carregou - poss√≠vel bloqueio de CSP');
                return false;
            }
        }

        // Teste 2: Inicializar Stripe
        function testStripeInit() {
            log('üîç Testando inicializa√ß√£o do Stripe...');
            try {
                // Usando chave p√∫blica de teste
                const stripe = Stripe('pk_test_51234567890abcdef');
                addTestResult('Stripe Init', true, 'Stripe inicializado com sucesso');
                return stripe;
            } catch (error) {
                addTestResult('Stripe Init', false, `Erro na inicializa√ß√£o: ${error.message}`);
                return null;
            }
        }

        // Teste 3: Verificar CSP Violations
        function testCSPViolations() {
            log('üîç Monitorando viola√ß√µes de CSP...');
            let violations = 0;
            
            document.addEventListener('securitypolicyviolation', (e) => {
                violations++;
                log(`‚ùå CSP VIOLATION: ${e.violatedDirective} - ${e.blockedURI}`, 'error');
                addTestResult('CSP Violations', false, `${violations} viola√ß√£o(√µes) detectada(s)`);
            });

            // Aguardar 3 segundos para capturar viola√ß√µes
            setTimeout(() => {
                if (violations === 0) {
                    addTestResult('CSP Violations', true, 'Nenhuma viola√ß√£o de CSP detectada');
                }
            }, 3000);
        }

        // Teste 4: Teste de Checkout (simulado)
        function testStripeCheckout() {
            log('üîç Testando funcionalidade de checkout...');
            
            if (!testStripeSDK()) {
                return;
            }

            try {
                // Simular cria√ß√£o de checkout session
                const stripe = Stripe('pk_test_51234567890abcdef');
                
                // Teste se consegue acessar m√©todos do Stripe
                if (stripe && typeof stripe.redirectToCheckout === 'function') {
                    addTestResult('Stripe Checkout', true, 'M√©todos de checkout dispon√≠veis');
                    log('‚úÖ Stripe Checkout est√° funcional!');
                } else {
                    addTestResult('Stripe Checkout', false, 'M√©todos de checkout n√£o dispon√≠veis');
                }
            } catch (error) {
                addTestResult('Stripe Checkout', false, `Erro no checkout: ${error.message}`);
            }
        }

        // Teste 5: Verificar recursos carregados
        function testResourceLoading() {
            log('üîç Verificando carregamento de recursos...');
            
            const scripts = document.querySelectorAll('script[src*="stripe"]');
            if (scripts.length > 0) {
                addTestResult('Stripe Resources', true, `${scripts.length} script(s) do Stripe carregado(s)`);
            } else {
                addTestResult('Stripe Resources', false, 'Nenhum script do Stripe encontrado');
            }
        }

        // Executar todos os testes
        function runAllTests() {
            log('üöÄ Iniciando bateria completa de testes...');
            testResults = [];
            
            testCSPViolations();
            testStripeSDK();
            testStripeInit();
            testResourceLoading();
            
            setTimeout(() => {
                testStripeCheckout();
                log('‚úÖ Todos os testes conclu√≠dos!');
            }, 1000);
        }

        function clearConsole() {
            consoleOutput.textContent = 'Console limpo...\n';
        }

        // Executar testes automaticamente ao carregar
        window.addEventListener('load', () => {
            log('üåê P√°gina carregada - iniciando testes autom√°ticos...');
            setTimeout(runAllTests, 1000);
        });

        // Capturar erros JavaScript
        window.addEventListener('error', (e) => {
            log(`‚ùå ERRO JS: ${e.message} em ${e.filename}:${e.lineno}`, 'error');
        });

        log('üîß Sistema de testes inicializado');
    </script>
</body>
</html>