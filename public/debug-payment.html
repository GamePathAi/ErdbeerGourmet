<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Payment - Acesso Manual</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-red-50 to-orange-50 min-h-screen flex items-center justify-center">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-red-600 mb-4">üö® Debug Payment - Acesso Manual</h1>
            <p class="text-gray-600">Ferramenta de emerg√™ncia para liberar acesso quando o webhook falha</p>
        </div>
        
        <div class="mb-6">
            <label for="session-id" class="block text-sm font-medium text-gray-700 mb-2">
                Session ID do Stripe:
            </label>
            <input 
                type="text" 
                id="session-id" 
                placeholder="cs_live_..." 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
            >
            <p class="text-xs text-gray-500 mt-1">Cole aqui o session_id da URL de sucesso</p>
        </div>
        
        <div class="flex gap-4 mb-6">
            <button 
                id="verify-btn"
                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg"
            >
                üîç Verificar Pagamento
            </button>
            <button 
                id="manual-access-btn"
                class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg"
                disabled
            >
                üîì Liberar Acesso Manual
            </button>
        </div>
        
        <div id="status" class="mb-6">
            <!-- Status messages will appear here -->
        </div>
        
        <div id="payment-info" class="hidden bg-gray-50 p-4 rounded-lg mb-6">
            <h3 class="font-bold text-gray-800 mb-2">Informa√ß√µes do Pagamento:</h3>
            <div id="payment-details"></div>
        </div>
        
        <div id="access-link" class="hidden bg-green-50 p-4 rounded-lg text-center">
            <h3 class="font-bold text-green-800 mb-2">‚úÖ Acesso Liberado!</h3>
            <a 
                id="ebook-link" 
                href="#" 
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg inline-block"
                target="_blank"
            >
                üçì Acessar Ebook Agora
            </a>
        </div>
    </div>
    
    <script>
        let currentSessionId = '';
        let paymentVerified = false;
        
        // Get session_id from URL if present
        const urlParams = new URLSearchParams(window.location.search);
        const sessionIdFromUrl = urlParams.get('session_id');
        if (sessionIdFromUrl) {
            document.getElementById('session-id').value = sessionIdFromUrl;
        }
        
        document.getElementById('verify-btn').addEventListener('click', verifyPayment);
        document.getElementById('manual-access-btn').addEventListener('click', createManualAccess);
        
        async function verifyPayment() {
            const sessionId = document.getElementById('session-id').value.trim();
            
            if (!sessionId) {
                showStatus('‚ùå Por favor, insira um Session ID', 'error');
                return;
            }
            
            currentSessionId = sessionId;
            showStatus('üîç Verificando pagamento no Stripe...', 'loading');
            
            try {
                const baseUrl = (window.location.hostname === 'localhost' && window.location.port !== '4173') ? 'http://localhost:8888' : window.location.origin;
                const response = await fetch(`${baseUrl}/.netlify/functions/stripe-verify/${sessionId}`);
                const data = await response.json();
                
                if (response.ok) {
                    paymentVerified = true;
                    showPaymentInfo(data);
                    document.getElementById('manual-access-btn').disabled = false;
                    showStatus('‚úÖ Pagamento verificado! Pode liberar acesso manual.', 'success');
                } else {
                    showStatus(`‚ùå Erro: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Erro ao verificar: ${error.message}`, 'error');
            }
        }
        
        async function createManualAccess() {
            if (!paymentVerified) {
                showStatus('‚ùå Primeiro verifique o pagamento', 'error');
                return;
            }
            
            showStatus('üîì Criando acesso manual...', 'loading');
            
            try {
                const baseUrl = (window.location.hostname === 'localhost' && window.location.port !== '4173') ? 'http://localhost:8888' : window.location.origin;
                const response = await fetch(`${baseUrl}/.netlify/functions/manual-access`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ session_id: currentSessionId })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAccessLink(data.accessToken);
                    showStatus('‚úÖ Acesso manual criado com sucesso!', 'success');
                } else {
                    showStatus(`‚ùå Erro ao criar acesso: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            const colors = {
                loading: 'bg-blue-100 border-blue-400 text-blue-700',
                success: 'bg-green-100 border-green-400 text-green-700',
                error: 'bg-red-100 border-red-400 text-red-700'
            };
            
            statusDiv.innerHTML = `
                <div class="${colors[type]} border px-4 py-3 rounded">
                    ${message}
                </div>
            `;
        }
        
        function showPaymentInfo(data) {
            const infoDiv = document.getElementById('payment-info');
            const detailsDiv = document.getElementById('payment-details');
            
            detailsDiv.innerHTML = `
                <p><strong>Status:</strong> ${data.payment_status}</p>
                <p><strong>Valor:</strong> ${data.amount_total / 100} ${data.currency.toUpperCase()}</p>
                <p><strong>Email:</strong> ${data.customer_email}</p>
                <p><strong>Data:</strong> ${new Date(data.created * 1000).toLocaleString()}</p>
            `;
            
            infoDiv.classList.remove('hidden');
        }
        
        function showAccessLink(accessToken) {
            const linkDiv = document.getElementById('access-link');
            const link = document.getElementById('ebook-link');
            
            link.href = `/ebook-acesso.html?token=${accessToken}`;
            linkDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>